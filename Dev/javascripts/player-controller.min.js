const MediaEvent={ABORTED:1,CAN_PLAY:2,CAN_PLAY_THROUGH:3,DURATION_CHANGE:4,ENDED:5,ERROR:6,LOADED_DATA:7,LOADED_META_DATA:8,LOAD_START:9,PAUSE:10,PLAY:11,PLAYING:12,PROGRESS:13,RATE_CHANGE:14,SEEKED:15,SEEKING:16,STALLED:17,SUSPEND:18,TIME_UPDATE:19,VOLUME_CHANGE:20,WAITING:21,EXTERNAL:22};Object.freeze(MediaEvent);class MediaMessage{constructor(readyState,eventType,message){this.readyState=readyState,this.eventType=eventType,this.message=message}getMessage(){const _message={readyState:this.readyState,event:this.eventType,message:this.message};return JSON.stringify(_message)}}class MediaMessageChannel{constructor(controller,useConsoleForMessage=!1){this.controller=controller,this.useConsoleForMessage=useConsoleForMessage,this.errorDisplayed=!1,this._timeout=null,this._stalled=!1}videoHackListener(){const vid=document.querySelector("video");setTimeout((function(){const scene=document.querySelector("#scene_id");scene.renderer.setSize(scene.canvas.width,scene.canvas.height)}),500),vid.removeEventListener("canplay",this.videoHackListener)}onVideoPlaybackFailure(){this.controller.setLoader(!0,!0)}onVideoPlaybackSuccess(){this._stalled=!1,this._timeout&&clearTimeout(this._timeout),this.controller.setLoader(!1)}onVideoPlaybackWaiting(stalled=!1){this.controller.setLoader(!0,!1,!0),stalled&&(this._stalled=!0,this.retryPlay())}retryPlay(){self=this,this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(()=>{console.log(`player Stalled ${this._stalled}`),this._stalled&&(this.controller.video.load(),this.controller.play(this.controller.currentTime),this._stalled=!1,canvasRenderForIOS14())},1e4)}onVideoEvents(){const readyState=this.controller.video.readyState;4===readyState?this.onVideoPlaybackSuccess():this.onVideoPlaybackWaiting()}subscribe(code,self=this){const vid=this.controller.video;if(code==MediaEvent.ABORTED&&(vid.onabort=function(){self.onVideoPlaybackSuccess(),self.sendMessage(MediaEvent.ABORTED)}),code==MediaEvent.CAN_PLAY){vid.oncanplay=function(){self.onVideoPlaybackSuccess(),self.sendMessage(MediaEvent.CAN_PLAY)};const scene=document.querySelector("#scene_id");scene&&scene.isIOS&&vid.addEventListener("canplay",self.videoHackListener)}code==MediaEvent.CAN_PLAY_THROUGH&&(vid.oncanplaythrough=function(){self.onVideoPlaybackSuccess(),self.sendMessage(MediaEvent.CAN_PLAY_THROUGH)}),code==MediaEvent.DURATION_CHANGE&&(vid.ondurationchange=function(){self.sendMessage(MediaEvent.DURATION_CHANGE)}),code==MediaEvent.ENDED&&(vid.onended=function(){self.sendMessage(MediaEvent.ENDED)}),code==MediaEvent.ERROR&&(vid.onerror=function(){self.onVideoPlaybackFailure(),self.sendMessage(MediaEvent.ERROR)}),code==MediaEvent.LOADED_DATA&&(vid.onloadeddata=function(){self.onVideoPlaybackSuccess(),self.sendMessage(MediaEvent.LOADED_DATA)}),code==MediaEvent.LOADED_META_DATA&&(vid.onloadedmetadata=function(){self.sendMessage(MediaEvent.LOADED_META_DATA)}),code==MediaEvent.LOAD_START&&(vid.onloadstart=function(){self.onVideoPlaybackWaiting(),self.sendMessage(MediaEvent.LOAD_START)}),code==MediaEvent.PAUSE&&(vid.onpause=function(){self.sendMessage(MediaEvent.PAUSE)}),code==MediaEvent.PLAY&&(vid.onplay=function(){self.sendMessage(MediaEvent.PLAY)}),code==MediaEvent.PLAYING&&(vid.onplaying=function(){self.onVideoPlaybackSuccess(),self.sendMessage(MediaEvent.PLAYING)}),code==MediaEvent.PROGRESS&&(vid.onprogress=function(){self.onVideoEvents(),self.sendMessage(MediaEvent.PROGRESS)}),code==MediaEvent.RATE_CHANGE&&(vid.onratechange=function(){self.sendMessage(MediaEvent.RATE_CHANGE)}),code==MediaEvent.SEEKED&&(vid.onseeked=function(){self.sendMessage(MediaEvent.SEEKED)}),code==MediaEvent.SEEKING&&(vid.onseeking=function(){self.sendMessage(MediaEvent.SEEKING)}),code==MediaEvent.STALLED&&(vid.onstalled=function(){self.onVideoPlaybackWaiting(!0),self.sendMessage(MediaEvent.STALLED)}),code==MediaEvent.SUSPEND&&(vid.onsuspend=function(){self.sendMessage(MediaEvent.SUSPEND)}),code==MediaEvent.TIME_UPDATE&&(vid.ontimeupdate=function(){self.onVideoEvents(),self.sendMessage(MediaEvent.TIME_UPDATE)}),code==MediaEvent.VOLUME_CHANGE&&(vid.onvolumechange=function(){self.sendMessage(MediaEvent.VOLUME_CHANGE)}),code==MediaEvent.WAITING&&(vid.onwaiting=function(){self.onVideoPlaybackWaiting(),self.sendMessage(MediaEvent.WAITING)})}unsubscribe(code){const vid=this.controller.video;code==MediaEvent.ABORTED&&(vid.onabort=this.onVideoPlaybackSuccess),code==MediaEvent.CAN_PLAY&&(vid.oncanplay=this.onVideoPlaybackSuccess),code==MediaEvent.CAN_PLAY_THROUGH&&(vid.oncanplaythrough=this.onVideoPlaybackSuccess),code==MediaEvent.DURATION_CHANGE&&(vid.ondurationchange=null),code==MediaEvent.ENDED&&(vid.onended=null),code==MediaEvent.ERROR&&(vid.onerror=this.onVideoPlaybackFailure),code==MediaEvent.LOADED_DATA&&(vid.onloadeddata=this.onVideoPlaybackSuccess),code==MediaEvent.LOADED_META_DATA&&(vid.onloadedmetadata=null),code==MediaEvent.LOAD_START&&(vid.onloadstart=null),code==MediaEvent.PAUSE&&(vid.onpause=null),code==MediaEvent.PLAY&&(vid.onplay=null),code==MediaEvent.PLAYING&&(vid.onplaying=null),code==MediaEvent.PROGRESS&&(vid.onprogress=this.onVideoEvents()),code==MediaEvent.RATE_CHANGE&&(vid.onratechange=null),code==MediaEvent.SEEKED&&(vid.onseeked=null),code==MediaEvent.SEEKING&&(vid.onseeking=null),code==MediaEvent.STALLED&&(vid.onstalled=this.onVideoPlaybackFailure),code==MediaEvent.SUSPEND&&(vid.onsuspend=null),code==MediaEvent.TIME_UPDATE&&(vid.ontimeupdate=this.onVideoEvents()),code==MediaEvent.VOLUME_CHANGE&&(vid.onvolumechange=null),code==MediaEvent.WAITING&&(vid.onwaiting=this.onVideoPlaybackWaiting)}sendMessage(event,message=""){const mediaMessage=new MediaMessage(this.controller.video.readyState,event,message);try{return this._postMessage(mediaMessage.getMessage()),!0}catch(error){this.useConsoleForMessage?(console.warn("postMessage is not defined. Setting : MediaMessageChannel.postMessage = console.log"),MediaMessageChannel.postMessage=console.log):this.errorDisplayed||(console.warn("postMessage is not defined. Set : MediaMessageChannel.postMessage = someFunction"),this.errorDisplayed=!0)}return!1}_postMessage(message){MediaMessageChannel.postMessage(message)}}class MediaController{constructor(id){this.videoID=id,this.video=null,this.autoPlay=!0,this.channel=new MediaMessageChannel(this),this.__playerBuilt=!1,this.src=null,this.cam=null,this._flat=!1,this._iosVersion=this.iOSversion()[0],this.ios14=null,this.canvas=null,this.ctx=null}resetCamera(){this.cam.components["touch-look-controls"].yawObject.rotation.set(0,0,0),this.cam.components["touch-look-controls"].pitchObject.rotation.set(0,0,0)}toggleTouch(enabled=!0){this.cam.components["touch-look-controls"].data.enabled=enabled}togglePlayer(flat=!0,aspectRatio=16/9,rotation=0){var videosphere=document.querySelector("#videosphere");flat?(this.resetCamera(),videosphere.removeAttribute("geometry","radius"),videosphere.setAttribute("geometry","primitive","plane"),videosphere.setAttribute("geometry","width",aspectRatio),videosphere.object3D.rotation.y=Math.PI,videosphere.object3D.rotation.z=Math.PI/180*rotation,videosphere.object3D.position.y=1.6,videosphere.object3D.position.z=-1,setTimeout(()=>this.toggleTouch(!1),100)):(videosphere.removeAttribute("geometry","width"),videosphere.setAttribute("geometry","primitive","sphere"),videosphere.object3D.rotation.y=0,videosphere.object3D.rotation.z=0,videosphere.object3D.position.y=1.6,videosphere.object3D.position.z=0,setTimeout(()=>this.toggleTouch(!0),100)),"flat"!=videosphere.getAttribute("material").shader&&(this.resetShader(),this.unmute())}resetShader(){var vs;document.querySelector("#videosphere").setAttribute("material","shader","flat")}iOSversion(){if(/iP(hone|od|ad)/.test(navigator.platform)){var v=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);return[parseInt(v[1],10),parseInt(v[2],10),parseInt(v[3]||0,10)]}return navigator.platform}build360Player(autoplay=!0,vrBtn=!0,iosPerm=!0,video_src=null,muted=!0){this.ios14=/m3u8/.test(video_src)&&this._iosVersion>=14;const _ascene=`\n        <a-scene \n            loading-screen="dotsColor: white; backgroundColor: black" \n            vr-mode-ui="enabled: ${vrBtn}" \n            ar-mode-ui="enabled: false" \n            id="scene_id"\n            class="player"\n            device-orientation-permission-ui="enabled: ${iosPerm}"\n        >\n            <a-assets>\n                <video \n                    src="${video_src}"\n                    id="${this.videoID}" \n                    autoplay="${autoplay}" \n                    playsinline \n                    webkit-playsinline \n                    preload="auto" \n                    crossorigin="anonymous"\n                    ${muted?"muted":""}\n                ></video>\n                <canvas id="${this.videoID}-canvas" style="display: none;"></canvas>\n            </a-assets>\n            <a-entity id="camera" camera="active: true" position="0 1.6 0" touch-look-controls></a-entity>\n            <a-videosphere id="videosphere" src="#${this.ios14?this.videoID+"-canvas":this.videoID}" ${this.ios14?"canvas-updater":""} material="shader:flat;"></a-videosphere>\n\n        </a-scene>        \n        `,_video=`\n            <div class="video_frame"> \n                <video \n                    src="${video_src}"\n                    id="${this.videoID}" autoplay="${autoplay}" muted="${muted}"  playsinline webkit-playsinline preload="auto" crossorigin="anonymous"></video>\n            </div>\n        `;var videosphere;this.__playerBuilt?console.log("Player already built!!"):(this.__playerBuilt=!0,this.src=video_src,$("body").prepend(_ascene),this.cam=document.querySelector("#camera"),document.querySelector("#videosphere").addEventListener("materialvideoloadeddata",this.resetShader),this.video=document.getElementById(this.videoID),this.canvas=document.getElementById(`${this.videoID}-canvas`),this.ctx=this.canvas.getContext("2d"),this.ios14&&(self=this,this.video.addEventListener("playing",()=>{self.canvas.height=self.video.videoHeight,self.canvas.width=self.video.videoWidth}),canvasRenderForIOS14()))}get isFlat(){return this._flat}viewInFlat(fullscreen=!0,aspectRatio=null){if(this.__playerBuilt&&!this._flat){this._flat=!0;const ar=aspectRatio||(fullscreen?window.innerHeight/window.innerWidth:window.innerWidth/window.innerHeight);fullscreen?this.togglePlayer(!0,ar,90):this.togglePlayer(!0,ar)}return""}viewInMono(){return this.__playerBuilt&&this._flat&&(this._flat=!1,this.togglePlayer(!1)),""}setLoader(value,error=!1,buffering=!1){const spinner=$("#spinner");!0===value?spinner.show():spinner.hide(),error?spinner.addClass("error"):spinner.removeClass("error"),buffering?spinner.addClass("buffering"):spinner.removeClass("buffering")}seek(by_time){return this.currentTime(this.currentTime()+by_time),""}currentTime(time){return time<this.duration&&time>0?(this.video.currentTime=time,""):this.video.currentTime}play(time){return this.subscribeToBufferingEvents(),mediaController.setLoader(!0),this.video.play().then((function(){console.log("playing...")})).catch((function(error){mediaController.setLoader(!0),console.log("PlayBack Failed: "+JSON.stringify({code:error.code,message:error.message,name:error.name})),"Failed to load because no supported source was found."!==error.message&&"The element has no supported sources."!=error.message||hlsLoad()})),time&&(this.video.currentTime=time),""}pause(){return this.video.pause(),""}playbackRate(rate){return rate<5&&rate>-1?(this.video.playbackRate=rate,""):this.video.playbackRate}forceReplay(){return this.pause(),this.currentTime(0),init(!0),""}load(url,autoPlay=!1){return this.pause(),this.currentTime(0),playlist.streams[0]=url,init(!0),autoPlay?this.play():this.pause(),""}enterVRMode(){const scene=$("a-scene")[0];return scene.enterVR(),""}exitVRMode(){const scene=$("a-scene")[0];return scene.exitVR(),""}subscribeToAllEvents(){const codes=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21];for(var code of codes)this.channel.subscribe(code);return""}unSubscribeFromAllEvents(){const codes=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21];for(var code of codes)this.channel.unsubscribe(code);return""}subscribe(...codes){for(var code of codes)this.channel.subscribe(code);return""}unsubscribe(...codes){for(var code of codes)this.channel.unsubscribe(code);return""}mute(){return this.video.muted=!0,""}unmute(){return this.video.muted=!1,""}subscribeToBufferingEvents(){this.subscribe(MediaEvent.ABORTED,MediaEvent.CAN_PLAY,MediaEvent.CAN_PLAY_THROUGH,MediaEvent.ERROR,MediaEvent.LOADED_DATA,MediaEvent.LOAD_START,MediaEvent.PLAYING,MediaEvent.STALLED,MediaEvent.WAITING,MediaEvent.PROGRESS)}get state(){return this.video.readyState}get paused(){return this.video.paused}get duration(){return this.video.duration}get volume(){return 100*this.video.volume}get isMuted(){return this.video.muted}}function getUrlParameter(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex,results=new RegExp("[\\?&]"+name+"=([^&#]*)").exec(location.search);return null===results?null:decodeURIComponent(results[1].replace(/\+/g," "))}function processParams(){const url=getUrlParameter("video"),VRBtn=getUrlParameter("VRBtn"),autoPlay=getUrlParameter("autoPlay"),loop=getUrlParameter("loop"),debug=getUrlParameter("debug"),debugConsole=getUrlParameter("console"),iosPermissions=getUrlParameter("iosPerm");if("false"===iosPermissions&&$("a-scene").attr("device-orientation-permission-ui","enabled: false"),window.Hls.DefaultConfig.debug=!0,"false"===debugConsole?$(".debugger").hide():setupDebugger(),window.mediaController=new MediaController("video_player_id"),mediaController.build360Player(autoplay="false"!==autoPlay,vrBtn="false"!==VRBtn,iosPerm="false"!==iosPermissions,video_src=url),null!==url){if(playlist.streams[0]=url,"false"!==autoPlay?setTimeout(()=>{mediaController.currentTime()>0||mediaController.play()},3e3):mediaController.autoPlay=!1,"true"===loop&&(mediaController.video.loop=!0),"false"===VRBtn){var h=document.getElementsByTagName("head").item(0),s=document.createElement("style");s.type="text/css",s.appendChild(document.createTextNode(".a-enter-vr-button {display: none;}")),h.appendChild(s)}}else mediaController.setLoader(!0,!0);mediaController.subscribeToBufferingEvents(),"true"===debug&&subscribeToAllEvents(),window.mediaFilter=new MediaColorFilter("player")}function canvasRenderForIOS14(){mediaController.video&&mediaController.video.readyState===mediaController.video.HAVE_ENOUGH_DATA&&(mediaController.ctx.clearRect(0,0,mediaController.canvas.width,mediaController.canvas.height),mediaController.ctx.drawImage(mediaController.video,0,0,mediaController.canvas.width,mediaController.canvas.height)),requestAnimationFrame(canvasRenderForIOS14)}document.title="",document.addEventListener("DOMContentLoaded",processParams);